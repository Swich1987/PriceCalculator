<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Price Calculator</title>
</head>
<body>
<form method="post">
    {% csrf_token %}
    <label>Item count: </label>
    <input type="number" id="count" name="count" min="1" step="1">
    <br><br>

    <label>Price for one item: </label>
    <input type="number" id="price" name="price" min="1" step="any"> $
    <br><br>

    <input id="calc_total" type="button" value="Calculate total price" onclick="calculateTotal();"/>
    <label>Total gross price: </label>
    <b><label id="total_price"></label></b>
    <br><br><br><br>

    <input id="calc_price_with_discount" type="button" value="Calculate price with discount"
           onclick="calculatePriceWithDiscount();"/>
    <label>Price with discount: </label>
    <b><label id="price_with_discount"></label> $</b>
    <br><br><br><br>

    <label id="state_code_label">Select State: </label>
    <select id="state_code" name="state_code"></select>
    <br><br>

    <input id="calc_price_with_state_tax" type="button" value="Calculate price with state tax"
           onclick="calculatePriceWithStateTax();"/>
    <label>Price with state tax: </label>
    <b><label id="price_with_state_tax"></label> $</b>
    <br><br>

</form>
</body>
</html>

<script>

    function post_to_api(url, data) {
        let csrftoken = getCookie("csrftoken");

        return fetch(url, {
            method: "POST",
            body: JSON.stringify(data),
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json"
            }
        });
    }

    window.onload = function () {
        let state_promise = post_to_api('/api/state_code_list', {});

        state_promise
            .then(res => res.json())
            .then(
                json_data => {
                    let states_list = json_data['states'];
                    let states_select = document.getElementById("state_code");

                    for (let i = 0; i < states_list.length; i++) {

                        let opt = document.createElement('option');

                        opt.value = states_list[i];
                        opt.innerText = states_list[i];

                        states_select.appendChild(opt);
                    }


                }
            )
    }

    function calculateTotal() {
        let count = document.getElementById("count").value;
        let price = document.getElementById("price").value;
        let result_price = count * price;

        const total_price_label = document.getElementById("total_price");

        total_price_label.innerText = result_price.toFixed(2) + " $";
    }

    function calculatePriceWithDiscount() {
        let input_price = document.getElementById("total_price").innerText;
        let data = {price: parseInt(input_price)};

        let price_with_discount_promise = post_to_api('/api/price_with_discount', data);

        price_with_discount_promise
            .then(res => res.json())
            .then(
                json_data => {
                    let price_with_discount = json_data['price_with_discount'];
                    let price_with_discount_el = document.getElementById("price_with_discount");

                    price_with_discount_el.innerText = price_with_discount;
                }
            )

    }

    function calculatePriceWithStateTax() {
        let input_price = document.getElementById("price_with_discount").innerText;
        let state_code = document.getElementById("state_code").selectedOptions[0].innerText;
        let data = {price: parseInt(input_price), state_code: state_code}

        let price_with_discount_promise = post_to_api('/api/price_with_state_tax', data);

        price_with_discount_promise
            .then(res => res.json())
            .then(
                json_data => {
                    let price_with_state_tax = json_data['price_with_state_tax'];
                    let price_with_state_tax_el = document.getElementById("price_with_state_tax");

                    price_with_state_tax_el.innerText = price_with_state_tax;
                }
            )

    }

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');

        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];

            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

</script>